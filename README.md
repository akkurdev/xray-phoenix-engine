### X-Ray Engine Phoenix Edition



#### Общая информация

**X-Ray Phoenix** - это не более, чем попытка облагородить кодовую базу движка X-ray Engine, с целью повышения удобства работы с ней при создании пользовательских модификаций на игру, требующих внесения изменений в программный код. 

Все права на серию игр и сам движок по прежнему принадлежат компании GSC Game World.

В качестве основы была взята пользовательская модификация [OGSR](https://github.com/OGSR/OGSR-Engine), самой актуальной версии. Данная модификация была выбрана в силу отсутствия проблем при сборке и запуске движка, а также активной поддержки ее со стороны сообщества фанатов игры. 

На момент начала работы (08.02.2024 г), даже вполне рабочий движок имеет ряд серьезных проблем: 

- Кодовая база слишком запутана: нейминг и стилистика написания кода не выдержаны, многие переменные имеют неинформативные названия. Многие вещи реализованы путем использования директив препроцессора и других устаревших техник, вместо современных средств языка С++;
- Дерево каталогов с исходным кодом не отражает структуру решения в IDE;
- Код движка имеет множество внешних зависимостей неопределенной значимости - количество сторонних библиотек в разы превышает количество модулей самого движка;
- Код основан на модели мультиплеера, в силу чего, многие элементы движка и самой игры реализованы избыточно, за счет необходимости работы с сетью;
- Код имеет циклические зависимости - нередка ситуация, когда два модуля используют файлы друг друга, чтобы иметь возможность скомпилироваться;
- Многие игровые классы представляют собой ярчайшие реализации анти-паттерна "God object"; 
- В коде отсутствует банальная XML-документация, в связи с чем сложно разобраться с тем, что он делает в том или ином месте;
- В коде используется малоинформативный логгер для журналирования протекающих в движке процессов;
- Базовые участки кода (например - математические функции) не покрыты модульными тестами, что позволяет потенциально считать их кузницей багов;

и т. д.

Все вышеуказанные пункты делают внедрение новых фич максимально неудобным процессом, результат которого не дает гарантии работоспособности, что негативно сказывается на мотивации разработчиков модификации и времени ее создания.

В данной связи, было принято решение постепенно пересмотреть кодовую базу и, насколько это возможно, исправить проблемы, сохранив имеющуюся функциональность и работоспособность.



#### Цели

Каждая из поставленных целей предполагает решение максимум одной из вышеуказанных проблем или ее части. 

Перечень целей следующий: 

- Описать публичный API движка для упрощения дальнейшей навигации по нему (только xr-модули);
- Привести нейминг кодовой базы и ее стиль к одному виду;
- Максимально избавиться от директив препроцессора, в пользу средств языка программирования (constexpr, etc);
- Максимально избавиться от устаревшего кода, в пользу стандарта С++ 20 и новее;
- Привести дерево каталогов и структуру папок/фильтров в проектах и решении в полное соответствие друг другу;
- Максимально избавиться от сторонних зависимостей;
- Удалить весь мультиплеерный код и все, что с ним связано;
- Привести граф зависимостей модулей движка к ациклическому варианту;
- Максимально задействовать паттерны SOLID и т. п., избавиться от God-object классов;
- Реализовать возможность логирования в каждом классе и структуре движка, где это необходимо;
- Вынести все математические функции в отдельный модуль и максимально покрыть модульными тестами;
- Комплексно протестировать изменения.



#### Сборка движка

Чтобы собрать движок, понадобится Microsoft Visual Studio 2022, с установленной рабочей нагрузкой "*Разработка классических приложений С++*" и последним, на текущий момент, пакетом SDK для Windows 10.

Для того, чтобы протестировать результат сборки, и убедиться в его работоспособности, понадобится установленная на диск игра **S.T.A.L.K.E.R. Shadow of Chernobyl**. 

Порядок сборки X-Ray Mini:

- Открыть решение *xray-engine.sln* в Visual Studio;
- Настроить основной проект (процесс настройки описан ниже);
- Переместить каталог *resources/gamedata* в корневой каталог игры;
- Выбрать конфигурацию **Release**, а в качестве платформы решения - **x64**;
- Кликнуть правой кнопкой мыши по решению в Обозревателе решений;
- Выбрать в контекстном меню пункт **Собрать решение**;
- Дождаться окончания сборки.

Суть настройки заключается в открытии окна настроек проекта *xr3da* в IDE, и последующем указании в разделе *Свойства конфигурации -> Отладка* следующих значений:

- **Аргументы команды**: *-use-work-dir*;
- **Рабочий каталог**: *путь к корневому каталогу установленной игры, в котором находится файл fsgame.ltx*, куда ранее была помещена gamedata.
